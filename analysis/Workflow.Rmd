---
title: "Workflow"
author: "JalilRT"
date: "2021-07-24"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Package for all workflow

```{r}
pacman::p_load(tidyverse,ggsci,cowplot,ggpubr,data.table,gridGraphics,corrplot,formattable,ggsignif,htmltools,webshot)
```

## Experiment 1

Ploting the results of each Emotion comparison and between Emotion, sex and ethnicity.

```{r message=FALSE, warning=FALSE}
total.em<-read_csv("data/E1/Total_Emoción.csv")
total.sex<-read_csv("data/E1/Total_Sexo.csv")
total.et<-read_csv("data/E1/Total_Etnia.csv")

fig1a<-ggplot(data=total.em, aes(x=Emocion, y=Media, fill=Emocion)) +
  geom_bar(stat="identity", position=position_dodge(), colour="black")+
  theme_classic2()+
  theme(legend.position="none",axis.title.x=element_blank())+
  labs(y= 'Percentage (%)')+ylim(c(0,100))+
  geom_errorbar(aes(ymin=Media-Error, ymax=Media+Error),
                width=.1,                  
                position=position_dodge(.9))+
  scale_x_discrete(labels=c("Joy","Anger", "Neutral"))+
  scale_fill_nejm()

fig1b<-ggplot(data=total.et, aes(x=Etnia, y=Media, fill=Etnia)) +
  geom_bar(stat="identity", position=position_dodge(), colour="black")+
  theme_classic2()+
  theme(legend.position="none",axis.title.x=element_blank())+
  labs(y= ' ')+ylim(c(0,100))+
  geom_errorbar(aes(ymin=Media-Error, ymax=Media+Error),
                width=.1,                  
                position=position_dodge(.9))+
  scale_x_discrete(labels=c("Caucasian","Latin"))+
  scale_fill_nejm()

fig1c<-ggplot(data=total.sex, aes(x=Sexo, y=Media_S, fill=Sexo)) +
  geom_bar(stat="identity", position=position_dodge(), colour="black")+
  theme_classic2()+
  theme(legend.position="none",axis.title.x=element_blank())+
  labs(y= ' ')+ylim(c(0,100))+
  geom_errorbar(aes(ymin=Media_S-Error_S, ymax=Media_S+Error_S),
                width=.1,                  
                position=position_dodge(.9))+
  scale_x_discrete(labels=c("Men","Women"))+
  scale_fill_nejm()

# all together
fig1<-plot_grid(fig1a,fig1b,fig1c,ncol = 3,labels = "AUTO")
fig1
```



## Experiment 2

A Pearson's Chi-squared test for analysis of independence was carried out to evaluate the association between the categorical variables, facial expression and speech act, according to the frequency of responses.

```{r message=FALSE, warning=FALSE}
## Chi
Data.exp2 <- read_csv('data/E2/AH_Emo_dat.csv')

Data.exp2$Emocion <- Data.exp2$Emocion %>%
  str_replace_all("Alegria", "Joy") %>%
  str_replace_all("Enojo", "Anger") %>% 
  str_replace_all("Tristeza", "Sadness") %>%
  str_replace_all("Miedo","Fear") %>% 
  str_replace_all("Sorpresa", "Surprise") %>% 
  str_replace_all("Asco", "Disgust")
Data.exp2$AH <- Data.exp2$AH %>%
  str_replace_all("Orden", "Order") %>%
  str_replace_all("Exigencia", "Demand") %>% 
  str_replace_all("Peticion", "Petition") %>% 
  str_replace_all("Ruego", "E.Request")

chiData.exp2 <- chisq.test(Data.exp2$Emocion, Data.exp2$AH, correct = FALSE)
chiData.exp2
chiData.exp2$observed

#### Figure 3, corr ###
corrplot(t(chiData.exp2$residuals), is.corr = FALSE,method="color",
         tl.cex = 1.1, cl.ratio = 0.4,bg="black",addgrid.col = "black",
         tl.col = "black",tl.srt=45,col= colorRampPalette(c("#0072B5FF","white","#BC3C29FF"))(9)) 
mtext("X²(4, 4560) = 11877; p < 0.001", at=4.5, line=-26, cex=1)

```


## Experiment 3

```{r message=FALSE, warning=FALSE}
## Chi
Data.exp3 <- read_csv('data/E3/Data_Respuestas_AH.csv')

Data.exp3$Emocion <- Data.exp3$Emocion %>%
  str_replace_all("Alegria", "Joy") %>%
  str_replace_all("Enojo", "Anger") %>% 
  str_replace_all("Tristeza", "Sadness")
Data.exp3$Respuesta <- Data.exp3$Respuesta %>%
  str_replace_all("Afirmacion", "Assertion") %>%
  str_replace_all("Exigencia", "Demand") %>% 
  str_replace_all("Ruego", "E.Request")

chiData.exp3 <- chisq.test(Data.exp3$Emocion, Data.exp3$Respuesta, correct = FALSE)
chiData.exp3
chiData.exp3$observed

#### Figure 3, corr ###
corrplot(chiData.exp3$residuals, is.corr = FALSE,method="color",
         tl.cex = 1.1, cl.ratio = 0.4,bg="black",addgrid.col = "black",
         tl.col = "black",tl.srt=45,col= colorRampPalette(c("#0072B5FF","white","#BC3C29FF"))(9)) 
mtext("X²(4, 4560) = 11877; p < 0.001", at=2.1, line=-29, cex=1)
```

```{r message=FALSE, warning=FALSE}
Datos_verbos_30 <- read.csv('data/E3/verbos_piloto2_30_final.csv', encoding = "UTF-8")

Demand= percent(Datos_verbos_30$Exigencia/100)
Assertion = percent(Datos_verbos_30$Afirmación/100)
E.Request = percent(Datos_verbos_30$Ruego/100)
None = percent(Datos_verbos_30$Ninguno/100)
SA = Datos_verbos_30$AH
Significance = Datos_verbos_30$Significance

verbos_30 <- tibble('Speech act'=SA,Demand,Assertion,E.Request,None,Significance)

tabla2_verb30 <- formattable(verbos_30, list(
  Demand = color_bar(alpha("#BC3C29FF",0.5)),
  E.Request = color_bar(alpha("#0072B5FF",0.5)),
  Assertion = color_bar(alpha("#E18727FF",0.5)),
  None = color_bar('lightgray'),
  Significance = formatter("span",
                           style = x ~ style(color = ifelse(x, "green", "red")),
                           x ~ icontext(ifelse(x, "ok", "remove"), ifelse(x, "Yes", "No")))))

tabla2_verb30

```



## Experiment 4

```{r message=FALSE, warning=FALSE}
## Chi
Data.fMRI <- read_csv('data/E4/chi_2.csv')
colnames(Data.fMRI)<-c("Emotion","SA","Resp","time")
Data.fMRI$Emotion<-Data.fMRI$Emotion%>%str_replace("Alegría","Joy") %>%
  str_replace("Enojo", "Anger")%>%str_replace("Tristeza", "Sadness")%>%
  str_replace("Sin_rostro","Blur")
Data.fMRI$SA<-Data.fMRI$SA%>%str_replace("Afirmación","Assertion")%>%
  str_replace("Exigencia","Demand")%>%str_replace("Ruego","E.Request")%>%str_replace("Ninguno","None")
chiAH.fMRI <- chisq.test(Data.fMRI$Emotion, Data.fMRI$SA, correct = FALSE)
chiAH.fMRI$observed

#chisq.post.hoc(chiAH.fMRI$observed,control = "bonferroni")

#chisq.multcomp(chiAH.fMRI$observed, p.method = "none")

Data2.fMRI <- read_csv('data/E4/chi_3.csv')
shapiro.test(Data2.fMRI$timT)
kruskal.test(Data2.fMRI$timT~Data2.fMRI$EmResp, data=Data2.fMRI)
#pairwise.wilcox.test(x=Data2.fMRI$timT, g=Data2.fMRI$EmResp,p.adj = "bonferroni")

#### Figure 5, corr ###
corrplot(chiAH.fMRI$residuals, is.corr = FALSE,method="color",
         tl.cex = 1.1, cl.ratio = 0.4,bg="black",addgrid.col = "black",
         tl.col = "black",tl.srt=45,col= colorRampPalette(c("#0072B5FF","white","#BC3C29FF"))(9)) 
mtext("X²(9, 16) = 1047.8, p < 0.001", at=2.5, line=-29, cex=1)

#### Figure 5, Reaction time ####
only.associated<-Data2.fMRI %>% filter(EmResp == "AlegríaAfirmación" |
                                       EmResp == "EnojoExigencia" |
                                       EmResp == "TristezaRuego")
my_comparisons <- list( c("AlegríaAfirmación", "EnojoExigencia"), 
                        c("EnojoExigencia", "TristezaRuego"), 
                        c("AlegríaAfirmación", "TristezaRuego") )
fig5b<-ggviolin(only.associated,x="EmResp",y="timT",fill="EmResp",
         add = "boxplot", add.params = list(fill = "white"))+
  labs(x="Conjunction",y="Reaction time")+
  theme(legend.position = "none", axis.title = element_text(size=12, face="bold"))+
  scale_x_discrete(labels=c("Joy-Assertion","Anger-Demand", "Sadness-E. Request"))+  
  stat_compare_means(comparisons = my_comparisons, label = "p.signif")+
  stat_compare_means(label.y = 4000) +
  stat_summary(fun.data = function(x) data.frame(y=3800, label = paste("Mean=",round(mean(x),2))), geom="text")+
  scale_fill_nejm()

fig5b
```

Emotional categorization task

```{r message=FALSE, warning=FALSE}
## 
C4.Data.fMRI <- read_csv('data/E4/chi_C4.csv')
colnames(C4.Data.fMRI)<-c("Emotion","Resp","Resp_Corr")
C4.Data.fMRI$Emotion<-C4.Data.fMRI$Emotion%>%str_replace("Alegría","Joy") %>%
  str_replace("Enojo", "Anger")%>%str_replace("Tristeza", "Sadness")%>%
  str_replace("Sin_Rostro","Blur")
C4.Data.fMRI$Resp<-C4.Data.fMRI$Emotion%>%str_replace("Alegría","Joy") %>%
  str_replace("Enojo", "Anger")%>%str_replace("Tristeza", "Sadness")%>%
  str_replace("Sin_Rostro","Blur")
C4.chiAH.fMRI <- chisq.test(C4.Data.fMRI$Emotion, C4.Data.fMRI$Resp, correct = FALSE)
C4.chiAH.fMRI$observed

corrplot(C4.chiAH.fMRI$residuals, is.corr = FALSE,method="color",
         tl.cex = 1.1, cl.ratio = 0.4,bg="black",addgrid.col = "black",
         tl.col = "black",tl.srt=45,col= colorRampPalette(c("#E18727FF","white","white","#0072B5FF"))(9)) 
mtext("X²(9.16) = 638.37, p < 0.001", at=2.5, line=-25, cex=1)
```

Plots brain

```{r message=FALSE, warning=FALSE}
stat1lh<-ggdraw()+draw_image("data/E4/stat1lh.png")
stat1rh<-ggdraw()+draw_image("data/E4/stat1rh.png")
stat1lh180<-ggdraw()+draw_image("data/E4/stat1lh180.png")
stat1rh180<-ggdraw()+draw_image("data/E4/stat1rh180.png")
stat1<-plot_grid(stat1lh,stat1rh,stat1lh180,stat1rh180,nrow = 2)

stat2lh<-ggdraw()+draw_image("data/E4/stat2lh.png")
stat2rh<-ggdraw()+draw_image("data/E4/stat2rh.png")
stat2lh180<-ggdraw()+draw_image("data/E4/stat2lh180.png")
stat2rh180<-ggdraw()+draw_image("data/E4/stat2rh180.png")
stat2<-plot_grid(stat2lh,stat2rh,stat2lh180,stat2rh180,nrow = 2)

stat3lh<-ggdraw()+draw_image("data/E4/stat3lh.png")
stat3rh<-ggdraw()+draw_image("data/E4/stat3rh.png")
stat3lh180<-ggdraw()+draw_image("data/E4/stat3lh180.png")
stat3rh180<-ggdraw()+draw_image("data/E4/stat3rh180.png")
stat3<-plot_grid(stat3lh,stat3rh,stat3lh180,stat3rh180,nrow = 2)

stat4lh<-ggdraw()+draw_image("data/E4/stat4lh.png")
stat4rh<-ggdraw()+draw_image("data/E4/stat4rh.png")
stat4lh180<-ggdraw()+draw_image("data/E4/stat4lh180.png")
stat4rh180<-ggdraw()+draw_image("data/E4/stat4rh180.png")
stat4<-plot_grid(stat4lh,stat4rh,stat4lh180,stat4rh180,nrow = 2)

stats<-plot_grid(stat1,stat2,stat3,stat4,labels = "AUTO")
stats12<-plot_grid(stat1,stat2,labels = "AUTO")
stats34<-plot_grid(stat3,stat4,labels = c("C","D"))
stats12
stats34

## PPI
ppi.stat1lh<-ggdraw()+draw_image("data/E4/mvpa_lh.png")
ppi.stat1rh<-ggdraw()+draw_image("data/E4/mvpa_rh.png")
ppi.stat1lh180<-ggdraw()+draw_image("data/E4/mvpa_lh180.png")
ppi.stat1rh180<-ggdraw()+draw_image("data/E4/mvpa_rh180.png")
ppi.stat1<-plot_grid(ppi.stat1lh,ppi.stat1rh,ppi.stat1lh180,ppi.stat1rh180,ncol = 2)
ppi.mask1<-ggdraw()+draw_image("data/E4/mask.png",scale = 0.95)
ppi.mask2<-ggdraw()+draw_image("data/E4/masklh.png",scale = 0.95)
ppi.mask<-plot_grid(ppi.mask1,ppi.mask2,nrow = 2)
ppi.ms<-plot_grid(ppi.stat1,ppi.mask,ncol = 2,labels = "AUTO")

ppi.all<-ggdraw()+draw_image("data/E4/ppi_a2.png")
ppi<-plot_grid(ppi.ms,ppi.all,labels = c("","C"),nrow = 2)
ppi
```

